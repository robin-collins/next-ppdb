<!-- 1984b566-7ddf-460c-b1aa-1bbb133ff94a b2c3f95e-8394-49c3-b8ad-d5f31db9d2fd -->

# PPDB Next.js MVP – Ordered Multi‑Agent Implementation Plan

## Guiding Constraints

- Do not change DB schema; handle dirty data in application layer (see ROUTES_COMPONENTS.md “Database Migration Workflow”).
- Import Prisma from '@/generated/prisma' via '@/lib/prisma' singleton.
- Keep pages client-side (CSR) with Zustand stores; use Zod for validation.
- Follow STYLE_GUIDE.md: mandatory Header, Sidebar, animated background.
- Always update CHANGELOG.md and FILETREE.md when code changes are made.

---

## Phase 0 — Repo Hygiene & Baseline Verification (Single Agent)

- Validate current build, lint, type-check; ensure dev runs.
- Verify existing implemented pages and APIs function as documented.

Agent Prompt:

```text
Goal: Establish a green baseline.
Tasks:
1) Run pnpm check (type-check + lint + fmt:check). Fix trivial lint/format issues.
2) Run pnpm dev, smoke test: '/', '/customer/[id]', '/customers/add'.
3) Confirm Prisma import paths use '@/lib/prisma' and types from '@/generated/prisma'.
4) Record any gaps or deviations in CHANGELOG.md and ensure FILETREE.md reflects current files.
Acceptance:
- pnpm check passes.
- Key pages load without runtime errors.
- CHANGELOG.md + FILETREE.md updated.
Context:
- CURRENT_PLAN.md, ROUTES_COMPONENTS.md, STYLE_GUIDE.md, TODO_ROUTES_COMPONENTS.md.
```

---

## Phase 1 — API Parity Completion (Parallelizable: 2–3 Agents)

Target endpoints (ROUTES_COMPONENTS.md → APIs table):

- Animals: DELETE /api/animals/[id]; POST /api/animals/[id]/notes; DELETE /api/notes/[noteId]
- Customers History: GET /api/customers/history?months=&q=
- Breeds: GET/POST/PUT/DELETE under /api/breeds
- Reports: GET /api/reports/daily-totals

Agent Prompt (Animals Notes & Delete):

```text
Goal: Complete animal CRUD and notes parity.
Implement:
1) DELETE /api/animals/[id] with safe deletion.
2) POST /api/animals/[id]/notes to create note (align with legacy fields: note_text, note_date or production mapping as in ROUTES_COMPONENTS.md Notes section).
3) DELETE /api/notes/[noteId].
Requirements:
- Use Zod schemas in src/lib/validations/serviceNote.ts as reference; add/adjust to match production fields.
- Prisma import via '@/lib/prisma'.
- Keep MySQL compat (no mode:'insensitive').
- Update TODO_ROUTES_COMPONENTS.md checkboxes when done.
Acceptance:
- Endpoints return expected shapes; errors handled; type-check + lint pass.
Context:
- ROUTES_COMPONENTS.md (API details), CURRENT_PLAN.md (schemas), existing animals routes.
```

Agent Prompt (Customers History):

```text
Goal: Implement inactive Customers History API.
Implement:
- GET /api/customers/history?months=12|24|36&q=... returning customers with last/this visit max and pagination-ready shape.
Logic:
- Inactivity derived from max(animal.thisvisit, animal.lastvisit) per customer.
- Optional q filters surname/email/phone.
Constraints:
- Prisma MySQL compat; no schema changes; normalize phones.
Acceptance:
- Unit-tested query logic (lightweight), type-check + lint pass.
Context:
- ROUTES_COMPONENTS.md 'Confirmed Additions From Mock UI'.
```

Agent Prompt (Breeds + Daily Totals):

```text
Goal: Implement breeds CRUD and daily totals.
Implement:
1) /api/breeds (GET, POST); /api/breeds/[id] (PUT, DELETE).
2) /api/reports/daily-totals (counts + revenue for visits today).
Constraints:
- Map fields to production schema: breedname/avgtime/avgcost.
- Respect FK constraints on delete.
Acceptance:
- CRUD works on seed data; totals compute correctly for today.
Context:
- ROUTES_COMPONENTS.md Breeds & Reports sections; reference SQL in reference/PPDB.
```

---

## Phase 2 — Stores & Validation (Single Agent)

- Extend `useAnimalsStore` to support notes create/delete and DELETE animal.
- Add `useBreedsStore` (if needed) or inline page fetches; keep simple.
- Add Zod schemas or adapt existing to production naming where required.

Agent Prompt:

```text
Goal: Wire frontend state to new APIs.
Tasks:
1) Add actions to useAnimalsStore: addNote(animalId,...), deleteNote(noteId), deleteAnimal(id).
2) Create minimal Breed store or plain fetch utils for /breeds.
3) Ensure all fetches handle errors; surface via error state.
4) Keep persist/devtools as per patterns.
Acceptance:
- Stores compile, unit-test actions lightly, errors handled.
Context:
- CURRENT_PLAN.md 'Zod & Zustand Integration', existing stores.
```

---

## Phase 3 — Pages: Animal Detail (Primary) (Single Agent)

- Build `/animals/[id]` with `AnimalHeader`, `AnimalInfoCard`, `ServiceNotesCard`.
- CSR; consume new store actions.

Agent Prompt:

```text
Goal: Ship animal detail with notes parity.
Implement:
1) Page: src/app/animals/[id]/page.tsx.
2) Components: src/components/animals/AnimalHeader.tsx, AnimalInfoCard.tsx, ServiceNotesCard.tsx.
3) Features: edit fields; add/delete notes; navigate to customer.
Constraints:
- Follow STYLE_GUIDE.md (Header/Sidebar mandatory, layout, tokens).
- Map fields to production names via API mapping.
Acceptance:
- Page loads; edits persist; notes add/delete; no console errors.
Context:
- ROUTES_COMPONENTS.md Animals section; STYLE_GUIDE.md layout/components.
```

---

## Phase 4 — Pages: Customers History (Single Agent)

- Build `/customers/history` with `HistoryFilters`, `CustomerHistoryTable`, `StatsBar`.

Agent Prompt:

```text
Goal: Ship Customers History page.
Implement:
- Page: src/app/customers/history/page.tsx (CSR).
- Components: customerHistory/HistoryFilters.tsx, CustomerHistoryTable.tsx, StatsBar.tsx.
- Query API months=12|24|36 & q; show totals and oldest visit.
Constraints:
- STYLE_GUIDE: table styles, badges, layout.
Acceptance:
- Filters apply; table renders; stats correct; keyboard/tab accessible.
Context:
- ROUTES_COMPONENTS.md Confirmed Additions; STYLE_GUIDE table/filters.
```

---

## Phase 5 — Pages: Breeds Management (Single Agent)

- Build `/breeds` with `BreedForm`, `BreedTable` (inline edit/delete).

Agent Prompt:

```text
Goal: Ship Breeds CRUD page.
Implement:
- Page: src/app/breeds/page.tsx.
- Components: src/components/breeds/BreedForm.tsx, BreedTable.tsx.
- CRUD wires to /api/breeds; optimistic UI optional; basic validations.
Constraints:
- STYLE_GUIDE for tables/forms; no schema changes.
Acceptance:
- Create/update/delete work; list updates without reload.
Context:
- ROUTES_COMPONENTS.md Breeds; STYLE_GUIDE Forms & Table.
```

---

## Phase 6 — Pages: Reports Daily Totals (Single Agent)

- Build `/reports/daily-totals` with `DailyTotalsCard`.

Agent Prompt:

```text
Goal: Ship Daily Totals page.
Implement:
- Page: src/app/reports/daily-totals/page.tsx.
- Component: src/components/reports/DailyTotalsCard.tsx.
- Fetch /api/reports/daily-totals; display date/time, animal count, revenue.
Constraints:
- STYLE_GUIDE cards/typography; allow simple SSR or CSR.
Acceptance:
- Values render correctly against seed data for "today".
Context:
- ROUTES_COMPONENTS.md Reports; STYLE_GUIDE Cards.
```

---

## Phase 7 — Optional: Admin Backup Stub (Single Agent)

- Implement `/admin/backup` and `/api/admin/backup` stub (download placeholder).

Agent Prompt:

```text
Goal: Provide backup entry (optional).
Implement:
- API: GET /api/admin/backup returns dummy stream or JSON stub.
- Page: /admin/backup with CTA button, explains stub behavior.
Acceptance:
- Endpoint reachable; page visible; no errors.
Context:
- ROUTES_COMPONENTS.md Admin (optional).
```

---

## Phase 8 — Design Fidelity & Shared Components (Parallelizable)

- Add shared components from Potential list that improve UX but are not mandatory for parity (Breadcrumbs, Toast, ConfirmDialog, Pagination, LoadingState).
- Apply STYLE_GUIDE mandatory elements on all pages.

Agent Prompt:

```text
Goal: Improve UX fidelity per STYLE_GUIDE.
Tasks:
1) Add Breadcrumbs, Toast, ConfirmDialog, Pagination, LoadingState components.
2) Integrate where high-impact: search/results, detail pages, breeds.
3) Ensure Header/Sidebar present on all pages; background and tokens applied.
Acceptance:
- Visual parity with mockups; components reusable.
Context:
- STYLE_GUIDE.md; ROUTES_COMPONENTS.md Potential section; existing pages.
```

---

## Phase 9 — QA, Accessibility, and Hardening (Single Agent)

- Keyboard navigation, ARIA labels, focus states.
- Error handling surfaces via ErrorDisplay pattern.

Agent Prompt:

```text
Goal: Accessibility & robustness.
Tasks:
1) Ensure focus/ARIA per STYLE_GUIDE Accessibility.
2) Add ErrorDisplay where network calls occur.
3) Verify phone normalization paths; dirty data handling.
Acceptance:
- Axe (or manual) checks pass basic a11y; error paths are user-friendly.
Context:
- STYLE_GUIDE Accessibility; ROUTES_COMPONENTS Notes on parity.
```

---

## Phase 10 — Documentation & Sign-off (Single Agent)

- Mark completed items in TODO_ROUTES_COMPONENTS.md.
- Update ROUTES_COMPONENTS.md status tables.
- Update CHANGELOG.md and FILETREE.md.

Agent Prompt:

```text
Goal: Finalize documentation and status.
Tasks:
1) Tick completed tasks in TODO_ROUTES_COMPONENTS.md.
2) Update status tables in ROUTES_COMPONENTS.md.
3) Update CHANGELOG.md with clear, dated entries; refresh FILETREE.md.
Acceptance:
- Docs reflect final state; reviewers can trace changes.
Context:
- All four docs.
```

---

## Workstream Coordination

- Run Phase 1 in parallel across 2–3 agents (Animals/Notes, Customers History, Breeds+Reports).
- Gate Phase 3–6 on corresponding APIs.
- Phase 8 can start incrementally once base pages exist.
- Keep PRs small and focused by feature boundary; include validation steps.

### To-dos

- [ ] Run baseline checks and fix trivial lint/format; update CHANGELOG/FILETREE
- [ ] Implement DELETE animal and notes POST/DELETE endpoints
- [ ] Implement GET /api/customers/history with months filter and search
- [ ] Implement breeds CRUD endpoints
- [ ] Implement GET /api/reports/daily-totals endpoint
- [ ] Extend Zustand stores and Zod schemas for new APIs
- [ ] Build /animals/[id] with AnimalHeader/InfoCard/ServiceNotesCard
- [ ] Build /customers/history with filters/table/stats
- [ ] Build /breeds with BreedForm and BreedTable
- [ ] Build /reports/daily-totals with DailyTotalsCard
- [ ] Add optional /admin/backup page and stub API
- [ ] Add shared UX components (Breadcrumbs, Toast, ConfirmDialog, Pagination)
- [ ] Harden accessibility, error handling, and dirty data paths
- [ ] Update TODO/ROUTES/CHANGELOG/FILETREE and mark completion
